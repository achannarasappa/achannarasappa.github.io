<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
<meta name="viewport"
      content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="ie=edge">

    <meta name="author" content="Ani Channarasappa">





<title>Using Terraform, AWS Lambda, and Locust to design and deploy a serverless web scraper system - Part 2/3 | ani.dev</title>



    <link rel="icon" href="/favicon.ico">




    <!-- stylesheets list from _config.yml -->
    
    <link rel="stylesheet" href="/css/style.css">
    



    <!-- scripts list from _config.yml -->
    
    <script src="/js/heap.js"></script>
    
    <script src="/js/script.js"></script>
    
    <script src="/js/tocbot.min.js"></script>
    



    
    
        
    


<meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="/atom.xml" title="ani.dev" type="application/atom+xml">
</head>
<body>
    <div class="wrapper">
        <header>
    <nav class="navbar">
        <div class="container">
            <div class="navbar-header header-logo"><a href="/">ani.dev</a></div>
            <div class="menu navbar-right">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/">About</a>
                
                <input id="switch_default" type="checkbox" class="switch_default">
                <label for="switch_default" class="toggleBtn"></label>
            </div>
        </div>
    </nav>

    
    <nav class="navbar-mobile" id="nav-mobile">
        <div class="container">
            <div class="navbar-header">
                <div>
                    <a href="/">ani.dev</a><a id="mobile-toggle-theme">·&nbsp;Light</a>
                </div>
                <div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div>
            </div>
            <div class="menu" id="mobile-menu">
                
                    <a class="menu-item" href="/archives">Posts</a>
                
                    <a class="menu-item" href="/">About</a>
                
            </div>
        </div>
    </nav>

</header>
<script>
    var mobileBtn = function f() {
        var toggleMenu = document.getElementsByClassName("menu-toggle")[0];
        var mobileMenu = document.getElementById("mobile-menu");
        if(toggleMenu.classList.contains("active")){
           toggleMenu.classList.remove("active")
            mobileMenu.classList.remove("active")
        }else{
            toggleMenu.classList.add("active")
            mobileMenu.classList.add("active")
        }
    }
</script>
        <div class="main">
            <div class="container">
    
    

    
    <article class="post-wrap">
        <header class="post-header">
            <h1 class="post-title">Using Terraform, AWS Lambda, and Locust to design and deploy a serverless web scraper system - Part 2/3</h1>
            
                <div class="post-meta">
                    

                    
                        <span class="post-time">
                        Date: <a href="#">January 26, 2020&nbsp;&nbsp;8:06:28</a>
                        </span>
                    
                    
                </div>
            
        </header>

        <div class="post-content">
            <p>This is part two of a three part series in which we’ll seek to understand:</p>
<p><strong>What areas in New York are most popular, have the best public transit connectivity, and offer the best amenities for their asking price?</strong></p>
<p>If you haven’t already, check out part one <a href="https://dev.to/achannarasappa/serverless-apartment-web-scraper-with-nodejs-aws-lambda-and-locust-ngk" target="_blank" rel="noopener">here</a> to get caught up.</p>
<h2 id="Looking-ahead"><a href="#Looking-ahead" class="headerlink" title="Looking ahead"></a>Looking ahead</h2><p>In this article we’ll cover the following:</p>
<ul>
<li>Using Terraform to provision the infrastructure for a serverless web crawler</li>
<li>Setup a recursive serverless function</li>
<li>Connecting to datastores and external systems</li>
<li>Schedule a daily run for the crawl job</li>
<li>Deploying the system to AWS</li>
</ul>
<h2 id="Recap"><a href="#Recap" class="headerlink" title="Recap"></a>Recap</h2><p>Thus far, we’ve put together and tested locally a configuration file that defines how the scraper will extract apartment listings from Craigslist. That configuration should look something like this:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./src/job.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; Client &#125; = <span class="built_in">require</span>(<span class="string">'pg'</span>)</span><br><span class="line"><span class="keyword">const</span> moment = <span class="built_in">require</span>(<span class="string">'moment'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">// non-configuration truncated for brevity</span></span><br><span class="line"><span class="comment">// see here for full file: https://github.com/achannarasappa/locust-examples/blob/master/apartment-listings/src/job.js</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  extract: <span class="keyword">async</span> ($, page) =&gt; transformListing(&#123;</span><br><span class="line">    <span class="string">'title'</span>: <span class="keyword">await</span> $(<span class="string">'.postingtitletext #titletextonly'</span>),</span><br><span class="line">    <span class="string">'price'</span>: <span class="keyword">await</span> $(<span class="string">'.postingtitletext .price'</span>),</span><br><span class="line">    <span class="string">'housing'</span>: <span class="keyword">await</span> $(<span class="string">'.postingtitletext .housing'</span>),</span><br><span class="line">    <span class="string">'location'</span>: <span class="keyword">await</span> $(<span class="string">'.postingtitletext small'</span>),</span><br><span class="line">    <span class="string">'datetime'</span>: <span class="keyword">await</span> page.$<span class="built_in">eval</span>(<span class="string">'.postinginfo time'</span>, (el) =&gt; el.getAttribute(<span class="string">'datetime'</span>)).catch(<span class="function"><span class="params">()</span> =&gt;</span> <span class="literal">null</span>),</span><br><span class="line">    <span class="string">'images'</span>: <span class="keyword">await</span> page.$$<span class="built_in">eval</span>(<span class="string">'#thumbs .thumb'</span>, (elements) =&gt; elements.map(<span class="function">(<span class="params">el</span>) =&gt;</span> el.getAttribute(<span class="string">'href'</span>))).catch(<span class="function"><span class="params">()</span> =&gt;</span> <span class="literal">null</span>),</span><br><span class="line">    <span class="string">'attributes'</span>: <span class="keyword">await</span> page.$$<span class="built_in">eval</span>(<span class="string">'.mapAndAttrs p.attrgroup:not(:nth-of-type(1)) span'</span>, (elements) =&gt; elements.map(<span class="function">(<span class="params">el</span>) =&gt;</span> el.textContent)).catch(<span class="function"><span class="params">()</span> =&gt;</span> <span class="literal">null</span>),</span><br><span class="line">    <span class="string">'google_maps_link'</span>: <span class="keyword">await</span> page.$<span class="built_in">eval</span>(<span class="string">'.mapaddress a'</span>, (el) =&gt; el.getAttribute(<span class="string">'href'</span>)).catch(<span class="function"><span class="params">()</span> =&gt;</span> <span class="literal">null</span>),</span><br><span class="line">    <span class="string">'description'</span>: <span class="keyword">await</span> $(<span class="string">'#postingbody'</span>),</span><br><span class="line">  &#125;),</span><br><span class="line">  after: <span class="keyword">async</span> (jobResult, snapshot, stop) =&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (isListingUrl(jobResult.response.url)) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="keyword">await</span> saveListing(jobResult.data)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (snapshot.queue.done.length &gt;= <span class="number">25</span>)</span><br><span class="line">      <span class="keyword">await</span> stop()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> jobResult;</span><br><span class="line"></span><br><span class="line">  &#125;,</span><br><span class="line">  start: <span class="function"><span class="params">()</span> =&gt;</span> <span class="literal">null</span>,</span><br><span class="line">  url: <span class="string">'https://newyork.craigslist.org/search/apa'</span>,</span><br><span class="line">  config: &#123;</span><br><span class="line">    name: <span class="string">'apartment-listings'</span>,</span><br><span class="line">    concurrencyLimit: <span class="number">2</span>,</span><br><span class="line">    depthLimit: <span class="number">100</span>,</span><br><span class="line">    delay: <span class="number">3000</span>,</span><br><span class="line">  &#125;,</span><br><span class="line">  filter: <span class="function">(<span class="params">links</span>) =&gt;</span> links.filter(<span class="function"><span class="params">link</span> =&gt;</span> isIndexUrl(link) || isListingUrl(link)),</span><br><span class="line">  connection: &#123;</span><br><span class="line">    redis: &#123;</span><br><span class="line">      port: <span class="number">6379</span>,</span><br><span class="line">      host: <span class="string">'localhost'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    chrome: &#123;</span><br><span class="line">      browserWSEndpoint: <span class="string">`ws://localhost:3000`</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>The next steps are to design the system, set up the infrastructure, and deploy the code.</p>
<h2 id="System-Design"><a href="#System-Design" class="headerlink" title="System Design"></a>System Design</h2><p>Let’s define some non-functional requirements and considerations to guide the design:</p>
<ul>
<li>No pre-existing infrastructure or systems - a greenfield build</li>
<li>Listings change frequently so the crawl should be run on a regular interval</li>
<li>Locust requires a Redis and Chrome instance for it’s queue and HTTP requests respectively</li>
<li>Network access<ul>
<li>Serverless run context will need network access to the data store for listings</li>
<li>Serverless run context will need network access to the Redis and Chrome instances for Locust</li>
<li>Chrome will need access to the internet to execute HTTP requests</li>
</ul>
</li>
<li>A database schema will need to be defined for the data store before it is usable</li>
</ul>
<p>With these in mind, the system diagram would look like this:</p>
<p><img src="https://thepracticaldev.s3.amazonaws.com/i/r09c4ezx7prgx2jubqio.png" alt="system"></p>
<p>Note: the database will be in the public subnet to simplify initial setup</p>
<h2 id="Infrastructure-setup"><a href="#Infrastructure-setup" class="headerlink" title="Infrastructure setup"></a>Infrastructure setup</h2><p>To setup and manage infrastructure, we’ll use <a href="https://www.terraform.io/" target="_blank" rel="noopener">Terraform</a> to define our infrastructure as configuration. The some of the Terraform resources needed for this setup are low level and not part of the core problem so we’ll pull in a few Terraform modules that provide higher order abstractions for these common resource collections. These are:</p>
<ul>
<li>AWS VPC - <a href="https://github.com/terraform-aws-modules/terraform-aws-vpc" target="_blank" rel="noopener">terraform-aws-modules/vpc/aws</a></li>
<li>AWS RDS - <a href="https://github.com/terraform-aws-modules/terraform-aws-rds" target="_blank" rel="noopener">terraform-aws-modules/rds/aws</a></li>
<li>Locust internal resources - <a href="https://github.com/achannarasappa/locust-aws-terraform" target="_blank" rel="noopener">github.com/achannarasappa/locust-aws-terraform</a></li>
</ul>
<h3 id="Compute-AWS-Lambda"><a href="#Compute-AWS-Lambda" class="headerlink" title="Compute (AWS Lambda)"></a>Compute (AWS Lambda)</h3><p><img src="https://thepracticaldev.s3.amazonaws.com/i/iht1ebhxeq3w47mq9ntf.png" alt="compute"></p>
<p>First we’ll start by setting up the Locust job in an AWS Lambda function:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># .&#x2F;infra&#x2F;main.tf</span><br><span class="line"></span><br><span class="line">provider &quot;aws&quot; &#123;</span><br><span class="line">  profile &#x3D; &quot;default&quot;</span><br><span class="line">  region  &#x3D; &quot;us-east-1&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_lambda_function&quot; &quot;apartment_listings_crawler&quot; &#123;</span><br><span class="line">  function_name    &#x3D; &quot;apartment-listings&quot;</span><br><span class="line">  filename         &#x3D; &quot;.&#x2F;src.zip&quot;</span><br><span class="line">  source_code_hash &#x3D; filebase64sha256(&quot;.&#x2F;src.zip&quot;)</span><br><span class="line"></span><br><span class="line">  handler &#x3D; &quot;src&#x2F;handler.start&quot;</span><br><span class="line">  runtime &#x3D; &quot;nodejs10.x&quot;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note here that a handler of <code>src/handler.start</code> is referenced along with a file bundle <code>./src.zip</code>. <code>src/handler.start</code> is the AWS Lambda function handler that is called when the function is triggered. Since with each Locust job run, the next job’s data is pulled from Redis queue, no arguments are needed from the handler and the handler ends up being fairly straightforward:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// ./src/handler.js</span></span><br><span class="line"><span class="keyword">const</span> &#123; execute &#125; = <span class="built_in">require</span>(<span class="string">'@achannarasappa/locust'</span>);</span><br><span class="line"><span class="keyword">const</span> job = <span class="built_in">require</span>(<span class="string">'./job.js'</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports.start = <span class="function"><span class="params">()</span> =&gt;</span> execute(job);</span><br></pre></td></tr></table></figure>

<p>Next, the source along with dependencies will need to be <a href="https://github.com/achannarasappa/locust-examples/blob/master/apartment-listings/package.json#L7" target="_blank" rel="noopener">bundled into <code>./src.zip</code></a>:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install &amp;&amp; zip -r ./infra/src.zip ./src package*.json node_modules</span><br></pre></td></tr></table></figure>

<p>Since <code>source_code_hash</code> has been set to <code>filebase64sha256</code> of the zip file, a rebundle will result in a diff in Terraform and the new file bundle will be pushed up.</p>
<p>From this point, the lambda can be provisioned to AWS with <code>terraform apply</code> but it won’t be all that useful since it still lacks connection information and network access to other resources in addition to basic permissions to run. We will come back to this Terraform block later to add those pieces once they’ve been setup elsewhere.</p>
<h3 id="Networking-VPC"><a href="#Networking-VPC" class="headerlink" title="Networking (VPC)"></a>Networking (VPC)</h3><p>In order to provision many of the resources needed for this system, a VPC is required. The <a href="https://github.com/terraform-aws-modules/terraform-aws-vpc" target="_blank" rel="noopener">terraform-aws-modules/vpc/aws</a> module can be used to setup a VPC along with some common resources associated with networking:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"># .&#x2F;infra&#x2F;main.tf</span><br><span class="line"></span><br><span class="line">module &quot;vpc&quot; &#123;</span><br><span class="line">  source &#x3D; &quot;terraform-aws-modules&#x2F;vpc&#x2F;aws&quot;</span><br><span class="line"></span><br><span class="line">  name &#x3D; &quot;apartment-listings&quot;</span><br><span class="line"></span><br><span class="line">  cidr &#x3D; &quot;10.0.0.0&#x2F;16&quot;</span><br><span class="line"></span><br><span class="line">  azs             &#x3D; [&quot;us-east-1c&quot;, &quot;us-east-1d&quot;]</span><br><span class="line">  private_subnets &#x3D; [&quot;10.0.1.0&#x2F;24&quot;, &quot;10.0.2.0&#x2F;24&quot;]</span><br><span class="line">  public_subnets  &#x3D; [&quot;10.0.101.0&#x2F;24&quot;, &quot;10.0.102.0&#x2F;24&quot;]</span><br><span class="line"></span><br><span class="line">  # enable public access to database for initial setup</span><br><span class="line">  create_database_subnet_group           &#x3D; true</span><br><span class="line">  create_database_subnet_route_table     &#x3D; true</span><br><span class="line">  create_database_internet_gateway_route &#x3D; true</span><br><span class="line">  enable_dns_hostnames                   &#x3D; true</span><br><span class="line">  enable_dns_support                     &#x3D; true</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>With the VPC setup, we can start adding resources to it starting with the database</p>
<h3 id="Storage-AWS-RDS"><a href="#Storage-AWS-RDS" class="headerlink" title="Storage (AWS RDS)"></a>Storage (AWS RDS)</h3><p><img src="https://thepracticaldev.s3.amazonaws.com/i/lgpmtjfn8id6dvs1v5w1.png" alt="database"></p>
<p>For the database, we’ll need to provision a Postgres instance to AWS RDS along with set up the schema. The configuration for a minimal database will be as follows:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"># .&#x2F;infra&#x2F;main.tf</span><br><span class="line"></span><br><span class="line">module &quot;db&quot; &#123;</span><br><span class="line">  source  &#x3D; &quot;terraform-aws-modules&#x2F;rds&#x2F;aws&quot;</span><br><span class="line">  version &#x3D; &quot;~&gt; 2.0&quot;</span><br><span class="line"></span><br><span class="line">  identifier &#x3D; &quot;apartment-listings-postgres&quot;</span><br><span class="line"></span><br><span class="line">  engine            &#x3D; &quot;postgres&quot;</span><br><span class="line">  engine_version    &#x3D; &quot;10.10&quot;</span><br><span class="line">  instance_class    &#x3D; &quot;db.t3.micro&quot;</span><br><span class="line">  allocated_storage &#x3D; 5</span><br><span class="line">  storage_encrypted &#x3D; false</span><br><span class="line"></span><br><span class="line">  name     &#x3D; var.postgres_database</span><br><span class="line">  username &#x3D; var.postgres_user</span><br><span class="line">  password &#x3D; var.postgres_password</span><br><span class="line">  port     &#x3D; var.postgres_port</span><br><span class="line"></span><br><span class="line">  publicly_accessible &#x3D; true</span><br><span class="line"></span><br><span class="line">  vpc_security_group_ids &#x3D; []</span><br><span class="line"></span><br><span class="line">  maintenance_window      &#x3D; &quot;Mon:00:00-Mon:03:00&quot;</span><br><span class="line">  backup_window           &#x3D; &quot;03:00-06:00&quot;</span><br><span class="line">  backup_retention_period &#x3D; 0</span><br><span class="line">  family                  &#x3D; &quot;postgres10&quot;</span><br><span class="line">  major_engine_version    &#x3D; &quot;10.10&quot;</span><br><span class="line"></span><br><span class="line">  enabled_cloudwatch_logs_exports &#x3D; [&quot;postgresql&quot;, &quot;upgrade&quot;]</span><br><span class="line"></span><br><span class="line">  subnet_ids          &#x3D; module.vpc.public_subnets</span><br><span class="line">  deletion_protection &#x3D; false</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Note here that the RDS instance is marked as publicly accessible and part of a public subnet so that we can perform the one time setup of the database schema. There are also no <code>vpc_security_group_ids</code> defined yet which will need to be added later.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;aws_security_group&quot; &quot;local-database-access&quot; &#123;</span><br><span class="line">  vpc_id &#x3D; &quot;$&#123;module.vpc.vpc_id&#125;&quot;</span><br><span class="line"></span><br><span class="line">  ingress &#123;</span><br><span class="line">    protocol  &#x3D; &quot;-1&quot;</span><br><span class="line">    self      &#x3D; true</span><br><span class="line">    from_port &#x3D; tonumber(var.postgres_port)</span><br><span class="line">    to_port   &#x3D; tonumber(var.postgres_port)</span><br><span class="line">    cidr_blocks &#x3D; [&quot;$&#123;chomp(data.http.myip.body)&#125;&#x2F;32&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  egress &#123;</span><br><span class="line">    from_port   &#x3D; 0</span><br><span class="line">    to_port     &#x3D; 0</span><br><span class="line">    protocol    &#x3D; &quot;-1&quot;</span><br><span class="line">    cidr_blocks &#x3D; [&quot;0.0.0.0&#x2F;0&quot;]</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">data &quot;http&quot; &quot;myip&quot; &#123;</span><br><span class="line">  url &#x3D; &quot;http:&#x2F;&#x2F;ipv4.icanhazip.com&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;null_resource&quot; &quot;db_setup&quot; &#123;</span><br><span class="line">  provisioner &quot;local-exec&quot; &#123;</span><br><span class="line">    command &#x3D; &quot;PGPASSWORD&#x3D;$&#123;var.postgres_password&#125; psql -h $&#123;module.db.this_db_instance_address&#125; -p $&#123;var.postgres_port&#125; -f ..&#x2F;db&#x2F;schema&#x2F;setup.sql $&#123;var.postgres_database&#125; $&#123;var.postgres_user&#125;&quot;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>The <code>aws_security_group_rule</code> will add a firewall rule that allows access from the machine being used to provision this system while the <code>null_resource</code> named <code>db_setup</code> will execute an ad-hoc sql query using <a href="https://www.postgresql.org/download/" target="_blank" rel="noopener"><code>psql</code></a> that will create the table and schema in the database (this will run locally so psql will need to be installed on the local machine). The <code>db</code> resource will also need to be updated with the newly created security group for local access:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vpc_security_group_ids &#x3D; [&quot;$&#123;aws_security_group.local-database-access&#125;&quot;]</span><br></pre></td></tr></table></figure>

<p>With the infra defined for the database, the we’ll need <a href="https://github.com/achannarasappa/locust-examples/blob/master/apartment-listings/db/schema/setup.sql" target="_blank" rel="noopener">sql statements</a> that sets up the database:</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> listing.home (</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">integer</span> <span class="keyword">NOT</span> <span class="literal">NULL</span>,</span><br><span class="line">    title <span class="built_in">character</span> <span class="built_in">varying</span>,</span><br><span class="line">    price <span class="built_in">numeric</span>,</span><br><span class="line">    location <span class="built_in">character</span> <span class="built_in">varying</span>,</span><br><span class="line">    bedroom_count <span class="built_in">numeric</span>,</span><br><span class="line">    <span class="keyword">size</span> <span class="built_in">character</span> <span class="built_in">varying</span>,</span><br><span class="line">    date_posted <span class="built_in">timestamp</span> <span class="keyword">with</span> <span class="built_in">time</span> zone,</span><br><span class="line">    <span class="keyword">attributes</span> jsonb,</span><br><span class="line">    images jsonb,</span><br><span class="line">    description <span class="built_in">character</span> <span class="built_in">varying</span>,</span><br><span class="line">    latitude <span class="built_in">character</span> <span class="built_in">varying</span>,</span><br><span class="line">    longitude <span class="built_in">character</span> <span class="built_in">varying</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<p>Looking back at the <code>./src/job.js</code> file, the properties here correspond 1:1 with the output of the <a href="https://github.com/achannarasappa/locust-examples/blob/master/apartment-listings/src/job.js#L54" target="_blank" rel="noopener"><code>transformListing</code> function</a>.</p>
<p>Now all the pieces are in place to provision the database. Also note that there are several variables defined in the preceding terraform blocks that will need to defined in <code>variables.tf</code>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">variable &quot;postgres_user&quot; &#123;</span><br><span class="line">  default &#x3D; &quot;postgres&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;postgres_password&quot; &#123;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;postgres_database&quot; &#123;</span><br><span class="line">  default &#x3D; &quot;postgres&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">variable &quot;postgres_port&quot; &#123;</span><br><span class="line">  default &#x3D; &quot;5432&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Scheduling-runs-AWS-Cloudwatch"><a href="#Scheduling-runs-AWS-Cloudwatch" class="headerlink" title="Scheduling runs (AWS Cloudwatch)"></a>Scheduling runs (AWS Cloudwatch)</h3><p><img src="https://thepracticaldev.s3.amazonaws.com/i/kmauinbkfcju9g2mw2jj.png" alt="cron"></p>
<p>In order to have the crawl execute on an interval, a cron-like solution will be needed that interfaces well with AWS Lambda. One way to achieve that is through a scheduled CloudWatch event:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;aws_cloudwatch_event_rule&quot; &quot;apartment_listings_crawler&quot; &#123;</span><br><span class="line">  name        &#x3D; &quot;apartment_listings_crawler&quot;</span><br><span class="line">  description &#x3D; &quot;Crawls apartment listings on a schedule&quot;</span><br><span class="line"></span><br><span class="line">  schedule_expression &#x3D; &quot;rate(1 day)&quot;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">resource &quot;aws_cloudwatch_event_target&quot; &quot;apartment_listings_crawler&quot; &#123;</span><br><span class="line">  rule &#x3D; &quot;$&#123;aws_cloudwatch_event_rule.apartment_listings_crawler.name&#125;&quot;</span><br><span class="line">  arn  &#x3D; &quot;$&#123;aws_lambda_function.apartment_listings_crawler.arn&#125;&quot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>This will trigger the Lambda once per day which will start a crawler job that will continue until a stop condition is met spawning additional Lambdas bounded by the <a href="https://github.com/achannarasappa/locust-examples/blob/master/apartment-listings/src/job.js#L104" target="_blank" rel="noopener">parameters in the job definition file</a>.</p>
<p>An additional resource-based permission is needed to allow CloudWatch events to trigger Lambdas:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;aws_lambda_permission&quot; &quot;apartment_listings_crawler&quot; &#123;</span><br><span class="line">  action        &#x3D; &quot;lambda:InvokeFunction&quot;</span><br><span class="line">  function_name &#x3D; &quot;$&#123;aws_lambda_function.apartment_listings_crawler.function_name&#125;&quot;</span><br><span class="line">  principal     &#x3D; &quot;events.amazonaws.com&quot;</span><br><span class="line">  source_arn    &#x3D; aws_cloudwatch_event_rule.apartment_listings_crawler.arn</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Locust-internal-resources"><a href="#Locust-internal-resources" class="headerlink" title="Locust internal resources"></a>Locust internal resources</h3><p><img src="https://thepracticaldev.s3.amazonaws.com/i/c7vw0etjv9vtblpmtvma.png" alt="locust"></p>
<p>The last remaining set of resources to add are the chrome instance which Locust will use to execute HTTP requests in a browser context and the Redis instance which will power Locust’s job queue. These are all defined within the Terraform module <a href="https://github.com/achannarasappa/locust-aws-terraform" target="_blank" rel="noopener"><code>github.com/achannarasappa/locust-aws-terraform</code></a>. Inputs for this module are:</p>
<ul>
<li><em>vpc_id</em> - VPC id from <code>apartment-listings</code> VPC defined earlier</li>
<li><em>private_subnet_ids</em> - list of private subnet ids from <code>apartment-listings</code> VPC defined earlier</li>
<li><em>public_subnet_ids</em> - list of public subnet ids from <code>apartment-listings</code> VPC defined earlier</li>
</ul>
<p>And outputs are:</p>
<ul>
<li><em>redis_hostname</em> - hostname of the Redis instance which will need to be passed to the AWS Lambda running Locust</li>
<li><em>chrome_hostname</em> - hostname of the Chrome instance which will need to be passed to the AWS Lambda running Locust</li>
<li><em>security_group_id</em> - AWS security group that the Redis and Chrome instances are a part of</li>
<li><em>iam_role_arn</em> - AWS IAM role with the proper permissions to access Chrome, Redis, and run Locust</li>
</ul>
<p>We’ll need to revisit the Lambda configuration to add the hostnames, role ARN, and security group with the outputs from this module in the next section. The security group can also be reused by the <code>db</code> module to allow access from the Lambda to Postgres:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">module &quot;db&quot; &#123;</span><br><span class="line">  ...</span><br><span class="line">  vpc_security_group_ids &#x3D; [&quot;$&#123;module.locust.security_group_id&#125;&quot;]</span><br><span class="line">  ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Tying-everything-together"><a href="#Tying-everything-together" class="headerlink" title="Tying everything together"></a>Tying everything together</h2><p><img src="https://thepracticaldev.s3.amazonaws.com/i/nawzn5btc7flzom3t2yl.png" alt="tying"></p>
<p>Earlier we set up a placeholder Lambda function that was missing a few key pieces that we now have:</p>
<ul>
<li>IAM role</li>
<li>VPC subnets</li>
<li>Security groups with dependent resources</li>
<li>Hostnames for Redis and Chrome plus connection information for Postgres</li>
</ul>
<p>Now that other resources have been setup, the <code>aws_lambda_function</code> can be updated with this information:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">resource &quot;aws_lambda_function&quot; &quot;apartment_listings_crawler&quot; &#123;</span><br><span class="line">  ...</span><br><span class="line"></span><br><span class="line">  role &#x3D; &quot;$&#123;module.locust.iam_role_arn&#125;&quot;</span><br><span class="line"></span><br><span class="line">  vpc_config &#123;</span><br><span class="line">    subnet_ids         &#x3D; concat(module.vpc.public_subnets, module.vpc.private_subnets)</span><br><span class="line">    security_group_ids &#x3D; [&quot;$&#123;module.locust.security_group_id&#125;&quot;]</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  environment &#123;</span><br><span class="line">    variables &#x3D; &#123;</span><br><span class="line">      CHROME_HOST       &#x3D; &quot;$&#123;module.locust.chrome_hostname&#125;&quot;</span><br><span class="line">      REDIS_HOST        &#x3D; &quot;$&#123;module.locust.redis_hostname&#125;&quot;</span><br><span class="line">      POSTGRES_HOST     &#x3D; &quot;$&#123;module.db.this_db_instance_address&#125;&quot;</span><br><span class="line">      POSTGRES_USER     &#x3D; &quot;$&#123;var.postgres_user&#125;&quot;</span><br><span class="line">      POSTGRES_PASSWORD &#x3D; &quot;$&#123;var.postgres_password&#125;&quot;</span><br><span class="line">      POSTGRES_DATABASE &#x3D; &quot;$&#123;var.postgres_database&#125;&quot;</span><br><span class="line">      POSTGRES_PORT     &#x3D; &quot;$&#123;var.postgres_port&#125;&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>Connection information for dependencies are passed into the Lambda run context to tell Locust <em>where</em> to connect. The security groups, subnets, and IAM role allow the Lambda to make outbound connections to Postgres, Chrome, and Redis.</p>
<p>Now that connection information for AWS is being passed into the Locust run context, the various <code>localhost</code> references in <code>./src/job.js</code> can be updated to use those environment variables.</p>
<ol>
<li><p>In the connection to Postgres (<code>saveListing</code>s function):</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> client = <span class="keyword">new</span> Client(&#123;</span><br><span class="line">  host: process.env.POSTGRES_HOST || <span class="string">'localhost'</span>,</span><br><span class="line">  database: process.env.POSTGRES_DATABASE || <span class="string">'postgres'</span>,</span><br><span class="line">  user: process.env.POSTGRES_USER || <span class="string">'postgres'</span>,</span><br><span class="line">  password: process.env.POSTGRES_PASSWORD || <span class="string">'postgres'</span>,</span><br><span class="line">  port: process.env.POSTGRES_PORT || <span class="number">5432</span>,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>
</li>
<li><p>In the connection object for Redis and Chrome:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  connection: &#123;</span><br><span class="line">    redis: &#123;</span><br><span class="line">      port: <span class="number">6379</span>,</span><br><span class="line">      host: process.env.REDIS_HOST || <span class="string">'localhost'</span></span><br><span class="line">    &#125;,</span><br><span class="line">    chrome: &#123;</span><br><span class="line">      browserWSEndpoint: <span class="string">`ws://<span class="subst">$&#123;process.env.CHROME_HOST || <span class="string">'localhost'</span>&#125;</span>:3000`</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</li>
</ol>
<p>With all of the connection details setup, the last step is to replace the dummy <a href="https://locust.dev/docs/api#function-start" target="_blank" rel="noopener"><code>start</code> function</a> with a function that will trigger a new job run. This will allow Locust to recursively trigger itself until a <a href="https://locust.dev/docs/concepts#stop-condition" target="_blank" rel="noopener">stop condition</a> is met. In this case, we need to initiate a new Lambda function:</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> AWS = <span class="built_in">require</span>(<span class="string">'aws-sdk'</span>);</span><br><span class="line"><span class="keyword">const</span> lambda = <span class="keyword">new</span> AWS.Lambda(&#123; <span class="attr">apiVersion</span>: <span class="string">'2015-03-31'</span> &#125;);</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  start: <span class="function"><span class="params">()</span> =&gt;</span> lambda.invoke(&#123;</span><br><span class="line">    FunctionName: <span class="string">'apartment-listings'</span>,</span><br><span class="line">    InvocationType: <span class="string">'Event'</span>,</span><br><span class="line">  &#125;).promise()</span><br><span class="line">    .catch(<span class="function">(<span class="params">err</span>) =&gt;</span> <span class="built_in">console</span>.log(err, err.stack)),</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Deploying-to-AWS"><a href="#Deploying-to-AWS" class="headerlink" title="Deploying to AWS"></a>Deploying to AWS</h2><p>The final setup is to provision the infrastructure and push the bundled source for the crawler. With the <code>source_code_hash = filebase64sha256(&quot;./src.zip&quot;)</code> in resource block for <code>aws_lambda_function</code>, the bundle <code>./src.zip</code> will be pushed along with a <code>terraform apply</code> so no distinct step is needed for that.</p>
<p>Bundle the source:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">rm -f ./infra/src.zip &amp;&amp; npm install &amp;&amp; zip -r ./infra/src.zip ./src package*.json node_modules</span><br></pre></td></tr></table></figure>

<p>Double check thar <code>terraform</code> and <code>psql</code> are installed locally then apply the changes with terraform:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ./infra &amp;&amp; terraform apply -auto-approve</span><br></pre></td></tr></table></figure>

<p>The provisioning will take about 10 minutes then the system should be up and running. The CloudWatch will automatically trigger the job once a day so no additional ad-hoc commands are need to run the crawler.</p>
<p>If you’d like to trigger the crawler immediately, this command can be used:</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">aws lambda invoke \</span><br><span class="line">--invocation-type Event \</span><br><span class="line">--<span class="keyword">function</span>-name apartment_listings_crawler \</span><br><span class="line">--region us-east-1  \</span><br><span class="line">--profile default \</span><br><span class="line">out.txt</span><br></pre></td></tr></table></figure>

<p>Refer to the Locust operational guide for tips on how to manage Locust and debug issues.</p>
<h2 id="Conclusion"><a href="#Conclusion" class="headerlink" title="Conclusion"></a>Conclusion</h2><p>Thus far in the series, we’ve learned how to build a serverless crawler with Locust in part 1 including:</p>
<ul>
<li>Analyzing how web data is related on a particular website and how this can be used by a crawler to discover page on the fly</li>
<li>Identifying relevant elements of a web page and how to extract them using Web APIs</li>
<li>Filtering out noise and optimizing crawler efficiency</li>
<li>Controlling crawler behaviors and setting stop conditions</li>
<li>Persisting to a datastore</li>
<li>Cleaning data before persistence</li>
</ul>
<p>In this article, we’ve covered how to deploy the crawler to AWS including:</p>
<ul>
<li>Using Terraform to provision the infrastructure for a serverless web crawler</li>
<li>Setup a recursive serverless function</li>
<li>Connecting to datastores and external systems</li>
<li>Schedule a daily run for the crawl job</li>
<li>Deploying the system to AWS</li>
</ul>
<p>In the next article in the series, we’ll take a look at the data that’s been gathered by the crawler to come to a data driven answer to the original question of where are the best areas to live in New York City.</p>

        </div>

        
        <section class="post-tags">
            <div>
                <span>Tag(s):</span>
                <span class="tag">
                    
                </span>
            </div>
            <div>
                <a href="javascript:window.history.back();">back</a>
                <span>· </span>
                <a href="/">home</a>
            </div>
        </section>
        <section class="post-nav">
            
                <a class="prev" rel="prev" href="/2021/05/25/functional-programming-in-go-with-generics/">Functional programming in Go with generics</a>
            
            
            <a class="next" rel="next" href="/2019/12/22/serverless-apartment-listing-scraper-pt-1/">Serverless apartment web scraper with NodeJS, AWS Lambda, and Locust - Part 1/3</a>
            
        </section>


    </article>
</div>

        </div>
        <footer id="footer" class="footer">
    <div class="copyright">
        <span>© Ani Channarasappa </span>
    </div>
</footer>
    </div>
</body>
</html>
